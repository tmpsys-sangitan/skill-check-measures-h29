/***********************************************************************/
/*                                                                     */
/*  FILE        :task04-4.c                                            */
/*  DATE        :Mon, Oct 20, 2017                                     */
/*  DESCRIPTION :Main Program                                          */
/*  CPU TYPE    :H8/3052F                                              */
/*                                                                     */
/*  This file is generated by Renesas Project Generator (Ver.4.16).    */
/*                                                                     */
/***********************************************************************/
#include "iodefine.h"
#include "conv.h"
#include "lcd.h"
#include "rsctl.h"

#pragma interrupt INT_IMIA2(vect=32)

int flug = 0;
int c = 0x80;           // カウンター
long period = 0x7FFF;
int accdata[] = {25997, 25954, 25911, 25869, 25826, 25784, 25742, 25700, 25659, 25617, 
                 25576, 25535, 25494, 25454, 25413, 25373, 25333, 25293, 25253, 25214, 
                 25174, 25135, 25096, 25058, 25019, 24981, 24942, 24904, 24866, 24829, 
                 24791, 24754, 24717, 24680, 24643, 24606, 24570, 24533, 24497, 24461, 
                 24425, 24389, 24354, 24318, 24283, 24248, 24213, 24178, 24143, 24109, 
                 24075, 24040, 24006, 23972, 23939, 23905, 23871, 23838, 23805, 23772, 
                 23739, 23706, 23673, 23641, 23608, 23576, 23544, 23512, 23480, 23448, 
                 23417, 23385, 23354, 23322, 23291, 23260, 23230, 23199, 23168, 23138, 
                 23107, 23077, 23047, 23017, 22987, 22957, 22927, 22898, 22868, 22839, 
                 22810, 22781, 22752, 22723, 22694, 22665, 22637, 22608, 22580, 22552, 
                 22524, 22496, 22468, 22440, 22412, 22384, 22357, 22330, 22302, 22275, 
                 22248, 22221, 22194, 22167, 22140, 22114, 22087, 22061, 22034, 22008, 
                 21982, 21956, 21930, 21904, 21878, 21853, 21827, 21802, 21776, 21751, 
                 21726, 21700, 21675, 21650, 21625, 21601, 21576, 21551, 21527, 21502, 
                 21478, 21453, 21429, 21405, 21381, 21357, 21333, 21309, 21286, 21262, 
                 21238, 21215, 21191, 21168, 21145, 21122, 21098, 21075, 21052, 21030, 
                 21007, 20984, 20961, 20939, 20916, 20894, 20871, 20849, 20827, 20805, 
                 20783, 20760, 20739, 20717, 20695, 20673, 20651, 20630, 20608, 20587, 
                 20565, 20544, 20523, 20501, 20480, 20459, 20438, 20417, 20396, 20376, 
                 20355, 20334, 20313, 20293, 20272, 20252, 20232, 20211, 20191, 20171, 
                 20151, 20131, 20111, 20091, 20071, 20051, 20031, 20011, 19992, 19972, 
                 19952, 19933, 19914, 19894, 19875, 19856, 19836, 19817, 19798, 19779, 
                 19760, 19741, 19722, 19703, 19685, 19666, 19647, 19629, 19610, 19592, 
                 19573, 19555, 19536, 19518, 19500, 19482, 19463, 19445, 19427, 19409, 
                 19391, 19373, 19356, 19338, 19320, 19302, 19285, 19267, 19250, 19232, 
                 19215, 19197, 19180, 19162, 19145, 19128, 19111, 19094, 19077, 19060, 
                 19043, 19026, 19009, 18992, 18975, 18958, 18942, 18925, 18908, 18892, 
                 18875, 18859, 18842, 18826, 18809, 18793, 18777, 18760, 18744, 18728, 
                 18712, 18696, 18680, 18664, 18648, 18632, 18616, 18600, 18584, 18569, 
                 18553, 18537, 18522, 18506, 18490, 18475, 18459, 18444, 18429, 18413, 
                 18398, 18383, 18367, 18352, 18337, 18322, 18307, 18292, 18277, 18262, 
                 18247, 18232, 18217, 18202, 18187, 18173, 18158, 18143, 18128, 18114, 
                 18099, 18085, 18070, 18056, 18041, 18027, 18012, 17998, 17984, 17969, 
                 17955, 17941, 17927, 17913, 17899, 17884, 17870, 17856, 17842, 17829, 
                 17815, 17801, 17787, 17773, 17759, 17746, 17732, 17718, 17704, 17691, 
                 17677, 17664, 17650, 17637, 17623, 17610, 17596, 17583, 17570, 17556, 
                 17543, 17530, 17517, 17503, 17490, 17477, 17464, 17451, 17438, 17425, 
                 17412, 17399, 17386, 17373, 17360, 17347, 17334, 17322, 17309, 17296, 
                 17283, 17271, 17258, 17246, 17233, 17220, 17208, 17195, 17183, 17170, 
                 17158, 17146, 17133, 17121, 17108, 17096, 17084, 17072, 17059, 17047, 
                 17035, 17023, 17011, 16999, 16987, 16975, 16963, 16951, 16939, 16927, 
                 16915, 16903, 16891, 16879, 16867, 16856, 16844, 16832, 16821, 16809, 
                 16797, 16786, 16774, 16762, 16751, 16739, 16728, 16716, 16705, 16693, 
                 16682, 16670, 16659, 16648, 16636, 16625, 16614, 16603, 16591, 16580, 
                 16569, 16558, 16547, 16535, 16524, 16513, 16502, 16491, 16480, 16469, 
                 16458, 16447, 16436, 16425, 16415, 16404, 16393, 16382, 16371, 16360, 
                 16350, 16339, 16328, 16318, 16307, 16296, 16286, 16275, 16264, 16254, 
                 16243, 16233, 16222, 16212, 16201, 16191, 16181, 16170, 16160, 16149, 
                 16139, 16129, 16118, 16108, 16098, 16088, 16077, 16067, 16057, 16047, 
                 16037, 16027, 16016, 16006, 15996, 15986, 15976, 15966, 15956, 15946, 
                 15936, 15926, 15916, 15906, 15897, 15887, 15877, 15867, 15857, 15847, 
                 15838, 15828, 15818, 15808, 15799, 15789, 15779, 15770, 15760, 15751, 
                 15741, 15731, 15722, 15712, 15703, 15693, 15684, 15674, 15665, 15655, 
                 15646, 15637, 15627, 15618, 15608, 15599, 15590, 15580, 15571, 15562, 
                 15553, 15543, 15534, 15525, 15516, 15507, 15497, 15488, 15479, 15470, 
                 15461, 15452, 15443, 15434, 15425, 15416, 15407, 15398, 15389, 15380, 
                 15371, 15362, 15353, 15344, 15335, 15326, 15318, 15309, 15300, 15291, 
                 15282, 15274, 15265, 15256, 15247, 15239, 15230, 15221, 15213, 15204, 
                 15195, 15187, 15178, 15170, 15161, 15152, 15144, 15135, 15127, 15118, 
                 15110, 15101, 15093, 15085, 15076, 15068, 15059, 15051, 15043, 15034, 
                 15026, 15017, 15009, 15001, 14993, 14984, 14976, 14968, 14960, 14951, 
                 14943, 14935, 14927, 14919, 14910, 14902, 14894, 14886, 14878, 14870, 
                 14862, 14854, 14846, 14838, 14830, 14822, 14814, 14806, 14798, 14790, 
                 14782, 14774, 14766, 14758, 14750, 14742, 14734, 14726, 14719, 14711, 
                 14703, 14695, 14687, 14680, 14672, 14664, 14656, 14649, 14641, 14633, 
                 14625, 14618, 14610, 14602, 14595, 14587, 14580, 14572, 14564, 14557, 
                 14549, 14542, 14534, 14527, 14519, 14511, 14504, 14496, 14489, 14481, 
                 14474, 14467, 14459, 14452, 14444, 14437, 14430, 14422, 14415, 14407, 
                 14400, 14393, 14385, 14378, 14371, 14364, 14356, 14349, 14342, 14334, 
                 14327, 14320, 14313, 14306, 14298, 14291, 14284, 14277, 14270, 14263, 
                 14255, 14248, 14241, 14234, 14227, 14220, 14213, 14206, 14199, 14192, 
                 14185, 14178, 14171, 14164, 14157, 14150, 14143, 14136, 14129, 14122, 
                 14115, 14108, 14101, 14094, 14088, 14081, 14074, 14067, 14060, 14053, 
                 14047, 14040, 14033, 14026, 14019, 14013, 14006, 13999, 13992, 13986, 
                 13979, 13972, 13965, 13959, 13952, 13945, 13939, 13932, 13925, 13919, 
                 13912, 13906, 13899, 13892, 13886, 13879, 13873, 13866, 13860, 13853, 
                 13847, 13840, 13833, 13827, 13820, 13814, 13808, 13801, 13795, 13788, 
                 13782, 13775, 13769, 13762, 13756, 13750, 13743, 13737, 13731, 13724, 
                 13718, 13711, 13705, 13699, 13693, 13686, 13680, 13674, 13667, 13661, 
                 13655, 13649, 13642, 13636, 13630, 13624, 13617, 13611, 13605, 13599, 
                 13593, 13586, 13580, 13574, 13568, 13562, 13556, 13550, 13544, 13537, 
                 13531, 13525, 13519, 13513, 13507, 13501, 13495, 13489, 13483, 13477, 
                 13471, 13465, 13459, 13453, 13447, 13441, 13435, 13429, 13423, 13417, 
                 13411, 13405, 13399, 13393, 13387, 13382, 13376, 13370, 13364, 13358, 
                 13352, 13346, 13341, 13335, 13329, 13323, 13317, 13311, 13306, 13300, 
                 13294, 13288, 13283, 13277, 13271, 13265, 13260, 13254, 13248, 13242, 
                 13237, 13231, 13225, 13220, 13214, 13208, 13203, 13197, 13191, 13186, 
                 13180, 13174, 13169, 13163, 13158, 13152, 13146, 13141, 13135, 13130, 
                 13124, 13119, 13113, 13108, 13102, 13096, 13091, 13085, 13080, 13074, 
                 13069, 13063, 13058, 13053, 13047, 13042, 13036, 13031, 13025, 13020};

void INT_IMIA2(void) {
    ITU2.TSR.BIT.IMFA = 0;  // フラグ初期化
    flug = 1;               // 割り込みフラグ
    c++;
    period = ITU2.GRA;
}

void main(void)
{
    char str[17];
    double tmp;
    int i, j;
    long Amax = 0xFFFF; // 前進の最高速度
    long Rmax = 0xFFFF; // 後退の最高速度
    
    // ポート初期化
    P4.DDR = 0x03;      // DCモーター IN1, 2
    P4.DR.BYTE = 0x03;  // 初期状態ブレーキ
    
    PA.DDR = 0x00;      // SW0~4
    
    // PWM初期化
    ITU1.TCR.BYTE = 0x23;   // GRAコンペアマッチ TCNTクリア 1/8クロック
    ITU.TMDR.BIT.PWM1 = 1;  // チャネル0 PWMモード
    ITU1.GRA = 10000;
    ITU1.GRB = ITU1.GRA + 1;
    
    // インプットキャプチャ初期化
    ITU2.TCR.BIT.CCLR = 1;  // TCNT2はICでクリア
    ITU2.TCR.BIT.TPSC = 3;  // 1/8クロック
    ITU2.TIOR.BIT.IOA = 5;  // 立ち上がりでICを起こす
    ITU2.TIER.BIT.IMIEA = 1;// GRA2のICで割り込み許可
    
    // LCD初期化
    init_lcd();             // LCD初期化
    clear_lcd();            // LCD画面リセット
    
    // タイマースタート
    ITU.TSTR.BIT.STR1 = 1;  // PWM制御開始
    ITU.TSTR.BIT.STR2 = 1;  // カウンタスタート
    
    // メインループ
    while(1){
        P4.DR.BYTE = 0x03;  // DCモーターブレーキ
        
        // 前進 or 後退の最高速度を測定
        if(!PA.DR.BIT.B0 || !PA.DR.BIT.B2){ // SW0またはSW2が押されたとき
            c = 0;                          // カウントリセット
            ITU1.GRB = ITU1.GRA + 1;        // 最高速度
        
            if(!PA.DR.BIT.B0){
                P4.DR.BYTE = 0x02;          // DCモーター前進
            
                while(c < 1200){
                    if(Amax > period && 1 < period){
                        Amax = period;      // 最高速度を更新
                        locate_lcd(6, 0);   // LCD2行目にカーソルを移動
                        ltoa(Amax, str);    // 取り込んだ値を文字列に変換
                        lcd_prints(str);    // LCDに文字列を表示
                        lcd_prints("  ");   // LCDの不要部分を上書き
                        
                        locate_lcd(12, 0);   // LCD2行目にカーソルを移動
                        itoa(1/(Amax * 0.32 / 1000000), str);
                                            // 取り込んだ値を文字列に変換
                        lcd_prints(str);    // LCDに文字列を表示
                        lcd_prints("  ");   // LCDの不要部分を上書き
                    }
                }
            }
            else if(!PA.DR.BIT.B2){
                P4.DR.BYTE = 0x01;          // DCモーター後退
            
                while(c < 1200){
                    if(Rmax > period && 1 < period){
                        Rmax = period;      // 最高速度を更新
                        locate_lcd(6, 1);   // LCD2行目にカーソルを移動
                        ltoa(Rmax, str);    // 取り込んだ値を文字列に変換
                        lcd_prints(str);    // LCDに文字列を表示
                        lcd_prints(" ");   // LCDの不要部分を上書き
                        
                        locate_lcd(12, 1);   // LCD2行目にカーソルを移動
                        itoa(1/(Rmax * 0.32 / 1000000), str);
                                            // 取り込んだ値を文字列に変換
                        lcd_prints(str);    // LCDに文字列を表示
                        lcd_prints(" ");   // LCDの不要部分を上書き
                    }
                }
            }
        }
        
        // 7[cm]/20[s]の台形制御
        if(!PA.DR.BIT.B1||!PA.DR.BIT.B3){
            // 最高速測定済み判定
            i = 0;
            if(!PA.DR.BIT.B1){              // 前進なら
                if(Amax != 0xFFFF){         // 前進最高速測定済みなら
                    i = 1;                  // 実動作を実行
                }
            }
            else if(!PA.DR.BIT.B3){         // 前進なら
                if(Rmax != 0xFFFF){         // 前進最高速測定済みなら
                    i = 1;                  // 実動作を実行
                }
            }
            
            // 実動作
            if(i != 0){                     // 最高速測定済みなら
                ITU1.GRB = ITU1.GRA * Amax / accdata[0];
                if(!PA.DR.BIT.B1){
                    P4.DR.BYTE = 0x02;      // DCモーター前進
                }
                else if(!PA.DR.BIT.B3){
                    P4.DR.BYTE = 0x01;      // DCモーター後退
                }
                
                // 加速区間
                locate_lcd(0, 0);		    // LCD1行目にカーソルを移動
                lcd_prints("up  ");         // LCDに文字列を表示
                locate_lcd(0, 1);           // LCD2行目にカーソルを移動
                itoa(ITU1.GRA * Amax / accdata[1], str);
                                            // 取り込んだ値を文字列に変換
                lcd_prints(str);            // LCDに文字列を表示
                lcd_prints("  ");           // LCDの不要部分を上書き
                for(i = 0; i < 900; i++){
                    while(flug == 0);       // 割り込み待機
                    flug = 0;
                    ITU1.GRB = ITU1.GRA * Amax / accdata[i];
                }
        
                // 定速区間
                locate_lcd(0, 0);		    // LCD1行目にカーソルを移動
                lcd_prints("hold");         // LCDに文字列を表示
                locate_lcd(0, 1);           // LCD2行目にカーソルを移動
                itoa(ITU1.GRA * Amax / accdata[899], str);
                                            // 取り込んだ値を文字列に変換
                lcd_prints(str);            // LCDに文字列を表示
                lcd_prints("  ");           // LCDの不要部分を上書き
                for(i = 0; i < (240 * 10); i++){
                    while(flug == 0);       // 割り込み待機
                    flug = 0;
                    ITU1.GRB = ITU1.GRA * Amax / accdata[899];
                }
        
                // 減速区間
                locate_lcd(0, 0);		    // LCD1行目にカーソルを移動
                lcd_prints("down");         // LCDに文字列を表示
                locate_lcd(0, 1);           // LCD2行目にカーソルを移動
                itoa(ITU1.GRA * Amax / accdata[899], str);
                                            // 取り込んだ値を文字列に変換
                lcd_prints(str);            // LCDに文字列を表示
                lcd_prints("  ");           // LCDの不要部分を上書き
                for(i = 899; i >= 0; i--){
                    while(flug == 0);       // 割り込み待機
                    flug = 0;
                    ITU1.GRB = ITU1.GRA * Amax / accdata[i];
                }
            }
        }
    }
}
