/***********************************************************************/
/*                                                                     */
/*  FILE        :task02.c                                              */
/*  DATE        :Mon, Oct 06, 2017                                     */
/*  DESCRIPTION :Main Program                                          */
/*  CPU TYPE    :H8/3052F                                              */
/*                                                                     */
/*  This file is generated by Renesas Project Generator (Ver.4.16).    */
/*                                                                     */
/***********************************************************************/

#include "iodefine.h"
#include "conv.h"
#include "lcd.h"
#include "rsctl.h"
#pragma interrupt INT_IMIA0(vect=24)

int flug = 0;
int c = 0;
unsigned char outdata[] = {0x30, 0x60, 0xC0, 0x90};
int accdata[] = {60140, 58029, 56126, 54398, 52821, 51374, 50039, 48803, 47655, 46584, 
                 45582, 44642, 43758, 42924, 42136, 41391, 40683, 40011, 39370, 38760, 
                 38177, 37620, 37086, 36574, 36083, 35612, 35158, 34721, 34300, 33894, 
                 33503, 33124, 32758, 32404, 32061, 31729, 31406, 31094, 30791, 30496, 
                 30210, 29931, 29660, 29397, 29140, 28890, 28646, 28408, 28176, 27950, 
                 27729, 27513, 27302, 27096, 26895, 26698, 26505, 26316, 26132, 25951, 
                 25774, 25600, 25430, 25263, 25100, 24939, 24782, 24627, 24476, 24327, 
                 24181, 24037, 23896, 23758, 23622, 23488, 23356, 23227, 23100, 22974, 
                 22851, 22730, 22611, 22493, 22378, 22264, 22152, 22041, 21932, 21825, 
                 21719, 21615, 21512, 21411, 21311, 21213, 21116, 21020, 20926, 20832, 
                 20740, 20650, 20560, 20472, 20384, 20298, 20213, 20129, 20046, 19964, 
                 19883, 19803, 19724, 19646, 19569, 19492, 19417, 19342, 19269, 19196, 
                 19124, 19052, 18982, 18912, 18843, 18775, 18708, 18641, 18575, 18510, 
                 18445, 18381, 18318, 18255, 18193, 18132, 18071, 18011, 17952, 17893, 
                 17834, 17777, 17719, 17663, 17606, 17551, 17496, 17441, 17387, 17333, 
                 17280, 17228, 17176, 17124, 17073, 17022, 16972, 16922, 16872, 16823, 
                 16775, 16727, 16679, 16632, 16585, 16538, 16492, 16446, 16401, 16356, 
                 16311, 16267, 16223, 16180, 16136, 16094, 16051, 16009, 15967, 15925, 
                 15884, 15843, 15803, 15763, 15723, 15683, 15644, 15605, 15566, 15527, 
                 15489, 15451, 15413, 15376, 15339, 15302, 15266, 15229, 15193, 15157, 
                 15122, 15087, 15052, 15017, 14982, 14948, 14914, 14880, 14846, 14813, 
                 14780, 14747, 14714, 14682, 14649, 14617, 14585, 14554, 14522, 14491, 
                 14460, 14429, 14398, 14368, 14337, 14307, 14277, 14248, 14218, 14189, 
                 14160, 14131, 14102, 14073, 14045, 14017, 13988, 13960, 13933, 13905, 
                 13878, 13850, 13823, 13796, 13769, 13743, 13716, 13690, 13664, 13638, 
                 13612, 13586, 13560, 13535, 13510, 13484, 13459, 13434, 13410, 13385, 
                 13361, 13336, 13312, 13288, 13264, 13240, 13216, 13193, 13169, 13146, 
                 13123, 13100, 13077, 13054, 13031, 13009, 12986, 12964, 12941, 12919, 
                 12897, 12875, 12854, 12832, 12810, 12789, 12767, 12746, 12725, 12704, 
                 12683, 12662, 12641, 12621, 12600, 12580, 12559, 12539, 12519, 12499
};

void INT_IMIA0(void) {
    ITU0.TSR.BIT.IMFA = 0;          // フラグ初期化
    flug = 1;                       // 割り込みフラグ
    c += 1;                         // カウントダウン
    TPC.NDRA1.BYTE = outdata[c%4];  // 信号変更
}

void main(void)
{
    int i, c;
    char str[17];

    // IO 初期設定
    PA.DDR = 0xf0;              // PA出力モード
    
    // LCD 初期設定
    init_lcd();                 // LCD初期化
    clear_lcd();                // LCD画面リセット
    
    // ITU 初期設定
    ITU0.TIOR.BIT.IOA = 0;      // コンペアマッチによる出力禁止
    ITU0.GRA = 62499;           // パルス周期 20ms
    ITU0.TCR.BYTE = 0x23;       // GRAコンペアマッチカウンタクリア
                                // TCNTクリア クロック 1/8
    ITU0.TIER.BIT.IMIEA = 1;    // 割り込み許可
    
    // TPC 初期設定
    TPC.TPMR.BIT.G1NOV = 0;     // TPC出力グループ1は通常動作
    TPC.NDERA.BYTE = 0xFF;      // TPC7からTPC0出力を許可
    TPC.TPCR.BIT.G1CMS = 0;     // TP7からTP3の出力トリガITU0コンペアマッチ
    TPC.NDRA1.BYTE = outdata[0];// 初期値
    
    while(1){
        // SW0が押されるまで待機
        locate_lcd(0, 0);		// LCD1行目にカーソルを移動
        lcd_prints("wait");     // LCDに文字列を表示
        while(PA.DR.BIT.B0);
        ITU.TSTR.BIT.STR0 = 1;
        
        // 加速区間
        locate_lcd(0, 0);		// LCD1行目にカーソルを移動
        lcd_prints("up  ");     // LCDに文字列を表示
        for(i = 0; i < 300; i++){
            while(flug == 0);   // 割り込み待機
            flug = 0;
            ITU0.GRA = accdata[i];
            TPC.NDRA1.BYTE = outdata[i%4];
        }
        
        // 定速区間
        locate_lcd(0, 0);		// LCD1行目にカーソルを移動
        lcd_prints("hold");     // LCDに文字列を表示
        for(i = 0; i < 750; i++){
            while(flug == 0);   // 割り込み待機
            flug = 0;
            ITU0.GRA = accdata[299];
            TPC.NDRA1.BYTE = outdata[i%4];
        }
        
        // 減速区間
        locate_lcd(0, 0);		// LCD1行目にカーソルを移動
        lcd_prints("down");     // LCDに文字列を表示
        for(i = 299; i >= 0; i--){
            while(flug == 0);   // 割り込み待機
            flug = 0;
            ITU0.GRA = accdata[i];
            TPC.NDRA1.BYTE = outdata[(300-i)%4];
        }
        ITU.TSTR.BIT.STR0 = 0;
    }
}
